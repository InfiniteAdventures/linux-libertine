% neue Umgebungen für das Listing-Paket
%
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{lstsample}[2004/12/26 mgn]
\RequirePackage{keyval}
\RequirePackage{ifthen}
\RequirePackage[final,writefile]{listings}
%
% Grundeinstellungen
\newcommand{\sample@lstsize}{0.48}                % Standardbreite für Listing (rel. zu linewidth)
\newcommand{\sample@codesize}{0.48}               % Standardbreite fpr Code (rel. zu linewidth)
\newcommand{\sample@lstparam}{}                   % Parameter für Listing (wird weitergereicht)
\newcommand{\sample@graparam}{}                   % Parameter für includegraphics (wird weitergereicht)
\newcommand{\sample@hpos}{c}                      % hor. Position für Code
\newcommand{\sample@hposcommand}{\centering}      % Befehl für hor. Position
\newcommand{\sample@toprulesize}{0.4pt}           % Dicke der top und bottom-Linie
\newcommand{\sample@midrulesize}{0.2pt}           % Dicke der Mittel-Linie
\newcommand{\sample@toprule}{}                    % Linie oben
\newcommand{\sample@bottomrule}{}                 % Linie unten
\newcommand{\sample@midrule}{}                    % Linie in der Mitten bei vsample
\newcommand{\sample@lfloat}{false}                % foat--Umgebung
\newcommand{\sample@lfloatpos}{}                  % foat--Umgebung pos
\newcommand{\sample@debug}{false}                 % debug
\newcommand{\sample@captionaboveskip}{0.75ex}     % Abstand der von Standard abgezogen wird.
\newcommand{\sample@grafloat}{f}                  % foat--Umgebung für Grafik f-> figure, s-> sfigure
\newcommand{\sample@gralabel}{}                   % label für Grafikverweis
\newcommand{\sample@grabox}{false}                % Box um Grafik
\newcommand{\sample@grafile}{}                    % Grafikdatei
\newcommand{\sample@lstfile}{}                    % Dateiname (+path)
\newcommand{\sample@lstexport}{false}             % export to file
%
% Debug-Meldungen ausgeben
\newcommand{\sample@debugshow}{%
  \typeout{lstsample: DEBUG ----------------------------------}
  \typeout{lstsize         = \sample@lstsize}
  \typeout{codesize        = \sample@codesize}
  \typeout{lstparam        = \sample@lstparam}
  \typeout{hpos            = \sample@hpos}
  \typeout{toprulesize     = \sample@toprulesize}
  \typeout{midrulesize     = \sample@midrulesize}
  \typeout{lfloat          = \sample@lfloat}
  \typeout{lfloatpos       = \sample@lfloatpos}
  \typeout{lstfile         = \sample@lstfile}
  \typeout{lstexport       = \sample@lstexport}
  \typeout{debug           = \sample@debug}
  \typeout{---------------------------------------------------}
}
%
\define@key{LS}{lstsize}[\sample@lstsize]{\renewcommand{\sample@lstsize}{#1}}
\define@key{LS}{codesize}[\sample@codesize]{\renewcommand{\sample@codesize}{#1}}
\define@key{LS}{lstparam}[]{\renewcommand{\sample@lstparam}{#1}}
\define@key{LS}{graparam}[]{\renewcommand{\sample@graparam}{#1}}
\define@key{LS}{hpos}[\sample@hpos]{%
  \renewcommand{\sample@hpos}{#1}%
  \ifthenelse{\equal{\sample@hpos}{c}}{\renewcommand{\sample@hposcommand}{\centering}}{}%
  \ifthenelse{\equal{\sample@hpos}{l}}{\renewcommand{\sample@hposcommand}{\raggedright}}{}%
  \ifthenelse{\equal{\sample@hpos}{r}}{\renewcommand{\sample@hposcommand}{\raggedleft}}{}%
  \ifthenelse{\equal{\sample@hpos}{b}}{\renewcommand{\sample@hposcommand}{}}{}%
}
\define@key{LS}{toprule}[true]{\renewcommand{\sample@toprule}{\rule{\linewidth}{\sample@toprulesize}}}
\define@key{LS}{midrule}[true]{\renewcommand{\sample@midrule}{\rule{\linewidth}{\sample@midrulesize}}}
\define@key{LS}{bottomrule}[true]{\renewcommand{\sample@bottomrule}{\rule{\linewidth}{\sample@toprulesize}}}
\define@key{LS}{allrule}[true]{%
  \renewcommand{\sample@toprule}{\rule{\linewidth}{\sample@toprulesize}}%
  \renewcommand{\sample@midrule}{\rule{\linewidth}{\sample@midrulesize}}%
  \renewcommand{\sample@bottomrule}{\rule{\linewidth}{\sample@toprulesize}}%
}
\define@key{LS}{toprulesize}[\sample@toprulesize]{\renewcommand{\sample@toprulesize}{#1}}
\define@key{LS}{midrulesize}[\sample@midrulesize]{\renewcommand{\sample@midrulesize}{#1}}
\define@key{LS}{lfloat}[true]{\renewcommand{\sample@lfloat}{#1}}
\define@key{LS}{lfloatpos}[\sample@lfloatpos]{\renewcommand{\sample@lfloatpos}{#1}}
\define@key{LS}{debug}[true]{\renewcommand{\sample@debug}{#1}}
\define@key{LS}{captionaboveskip}[\sample@sampleaboveskip]{\renewcommand{\sample@captionaboveskip}{#1}}
\define@key{LS}{grafloat}[\sample@grafloat]{\renewcommand{\sample@grafloat}{#1}}
\define@key{LS}{gralabel}[\sample@gralabel]{\renewcommand{\sample@gralabel}{#1}}
\define@key{LS}{grabox}[true]{\renewcommand{\sample@grabox}{#1}}
\define@key{LS}{grafile}[\sample@grafile]{\renewcommand{\sample@grafile}{#1}}
\define@key{LS}{lstfile}[\sample@lstfile]{\renewcommand{\sample@lstfile}{#1}}
\define@key{LS}{lstexport}[true]{\renewcommand{\sample@lstexport}{#1}}
%
\newcommand{\lstsampleset}[1]{\setkeys{LS}{#1}}
%
\lstnewenvironment{lstvsample}[1][]{%
  \ifhmode\endgraf\vspace{\parskip}\fi
  \vspace{\parskip}
  \setkeys{LS}{#1}%
  \lsthk@PreSet%
  \ifthenelse{\equal{\sample@lstparam}{}}{}{%
    \begingroup
    \def\x{\endgroup\setkeys{lst}}
    \expandafter\x\expandafter{\sample@lstparam}%
  }%
  \ifthenelse{\equal{\sample@debug}{true}}{\sample@debugshow}{}%
  \sample@common@begin
}
{%
  \lst@EndWriteFile\egroup
  \ifthenelse{\equal{\sample@lfloat}{true}}{\begin{figure}[\sample@lfloatpos]}{}%
  \noindent%
  \begin{minipage}{\linewidth}%
    \let\lst@ifdisplaystyle\iftrue%
    \lst@MakeCaption t%
    \sample@toprule\endgraf%
    \hbox to \linewidth{\box\sample@box\hss}%
    \sample@bottomrule\endgraf%
    \vspace{-\sample@captionaboveskip}
    \lst@MakeCaption b%
  \end{minipage}\endgraf\vspace{\parskip}%
  \pagebreak[2]%
  \ifthenelse{\equal{\sample@grafloat}{f}}{\begin{figure}}{\begin{sfigure}}%
      \sample@hposcommand%
      \ifthenelse{\equal{\sample@grabox}{true}}%
      {\fbox{\input{\jobname.listing\lst@gtempa.tex}}}{\input{\jobname.listing\lst@gtempa.tex}}
      \caption{Ergebnis zu \lstlistingname~\ref{\sample@gralabel}}
  \ifthenelse{\equal{\sample@grafloat}{f}}{\end{figure}}{\end{sfigure}}%
}
%
% ---------------------------------------
\newcommand{\lstvbildsample}[5][]{%
%  \ifhmode\endgraf\vspace{\parskip}\fi\
%  \vspace{\parskip}
  \begingroup
  \setkeys{LS}{#1}
  \lstinputlisting[#2]{#3}
  %\par\vspace{\parskip}%
  %
  \ifthenelse{\equal{\sample@lfloatpos}{}}{}{%
    \renewcommand{\fps@figure}{\sample@lfloatpos}
  }
  %
   \ifthenelse{\equal{\sample@grafloat}{f}}{\begin{figure}}{\begin{sfigure}}%
       \ifthenelse{\equal{\sample@grabox}{true}}%
       {\fbox{\includegraphics[#4]{#5}}}{\includegraphics[#4]{#5}}%
       \caption{Ergebnis zu \lstlistingname~\ref{\sample@gralabel}}
   \ifthenelse{\equal{\sample@grafloat}{f}}{\end{figure}}{\end{sfigure}}%
  \endgroup
}
% --------------------------------------------
%
%
\lstnewenvironment{lstsample}[1][]{%
  \hbadness=10000\hfuzz=100pt%
  \ifhmode\endgraf\vspace{\parskip}\fi\endgraf
  \vspace{\parskip}
  \setkeys{LS}{#1}%
  \lsthk@PreSet%
  \ifthenelse{\equal{\sample@lstparam}{}}{}{%
    \begingroup
    \def\x{\endgroup\setkeys{lst}}
    \expandafter\x\expandafter{\sample@lstparam}%
  }%
  \setkeys{lst}{linewidth=\sample@lstsize\linewidth}%
  \ifthenelse{\equal{\sample@debug}{true}}{\sample@debugshow}{}%
  \sample@common@begin
}
{%
  \lst@EndWriteFile\egroup
  \ifthenelse{\equal{\sample@lfloat}{true}}{\begin{figure}[\sample@lfloatpos]}{}%
  \noindent\sample@common@main%
  \ifthenelse{\equal{\sample@lfloat}{true}}{\end{figure}}{}%
}
%
\lstnewenvironment{lstbildsample}[1][]{%
  \ifhmode\endgraf\vspace{\parskip}\fi
  \vspace{\parskip}
  \setkeys{LS}{#1}%
  \lsthk@PreSet%
  \ifthenelse{\equal{\sample@lstparam}{}}{}{%
    \begingroup
    \def\x{\endgroup\setkeys{lst}}
    \expandafter\x\expandafter{\sample@lstparam}%
  }%
  \ifthenelse{\equal{\sample@graparam}{}}{}{%
    \begingroup
    \def\x{\endgroup\setkeys{Gin}}
    \expandafter\x\expandafter{\sample@graparam}%
  }%
  \setkeys{lst}{linewidth=\sample@lstsize\linewidth}%
  \ifthenelse{\equal{\sample@debug}{true}}{\sample@debugshow}{}%
  \ifthenelse{\equal{\sample@lstexport}{true}}{%
    \sample@common@begin@export}{\sample@common@begin}
}
{%
  \lst@EndWriteFile\egroup
  \ifthenelse{\equal{\sample@lfloat}{true}}{\begin{figure}[\sample@lfloatpos]}{}%
  \let\lst@ifdisplaystyle\iftrue%
  \noindent\sample@common@mainbild%
  \ifthenelse{\equal{\sample@lfloat}{true}}{\end{figure}}{}%
}
%
% --------------------------------------------
%
% neue Box fürs Listing
\newbox\sample@box
% Begin
\newcommand{\sample@common@begin}{%
    \setbox\sample@box=\hbox\bgroup
      \ifx\lst@@caption\@empty
         \global\let\lst@gtempa\@empty
      \else
         \begingroup
         \advance\c@lstlisting\@ne \xdef\lst@gtempa{.\thelstlisting}%
         \endgroup
      \fi
      \let\lst@MakeCaption\@gobble % captions temporaer deaktivieren
      \lst@BeginAlsoWriteFile{\jobname.listing\lst@gtempa.tex}%
}
% Begin-export
\newcommand{\sample@common@begin@export}{%
    \setbox\sample@box=\hbox\bgroup
      \ifx\lst@@caption\@empty
         \global\let\lst@gtempa\@empty
      \else
         \begingroup
         \advance\c@lstlisting\@ne \xdef\lst@gtempa{.\thelstlisting}%
         \endgroup
      \fi
      \let\lst@ifdisplaystyle\iftrue%
      \let\lst@MakeCaption\@gobble % captions temporaer deaktivieren
      \lst@BeginAlsoWriteFile{\sample@lstfile}%
}
% Main
\newcommand{\sample@common@main}{%
    \begin{minipage}{\linewidth}%
      \let\lst@ifdisplaystyle\iftrue%
      \lst@MakeCaption t%
      \sample@toprule\par
      \begin{minipage}{\sample@lstsize\linewidth}%
        \hbox to \linewidth{\box\sample@box\hss}%
      \end{minipage}%
      \hfill
      \begin{minipage}{\sample@codesize\linewidth}%
        \sample@hposcommand%
        \vspace{2pt}
        \input{\jobname.listing\lst@gtempa.tex}%
      \end{minipage}\par
      \sample@bottomrule%
      \vspace{-\sample@captionaboveskip}
      \lst@MakeCaption b%
    \end{minipage}
    \par\vspace{\parskip}
  }
\newcommand{\sample@common@mainbild}{%
    \begin{minipage}{\linewidth}%
      \let\lst@ifdisplaystyle\iftrue%
      \lst@MakeCaption t%
      \sample@toprule\par
      \begin{minipage}{\sample@lstsize\linewidth}%
        \hbox to \linewidth{\box\sample@box\hss}%
      \end{minipage}%
      \hfill
      \begin{minipage}{\sample@codesize\linewidth}%
        \sample@hposcommand%
        \vspace{2pt}
        \IfFileExists{\sample@grafile.pdf}{\includegraphics{\sample@grafile}}{%
        \IfFileExists{\sample@grafile.png}{\includegraphics{\sample@grafile}}{%
        \IfFileExists{\sample@grafile.jpg}{\includegraphics{\sample@grafile}}{%
        }}}
        %\includegraphics{\sample@grafile}
      \end{minipage}\par
      \sample@bottomrule%
      \vspace{-\sample@captionaboveskip}
      \lst@MakeCaption b%
    \end{minipage}
    \par\vspace{\parskip}%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\inputsamplebild}[7][]{%
  \vspace{\parskip}%
  \begin{minipage}{\linewidth}%
    \rule{\linewidth}{0.4pt}
    \begin{minipage}{#2\linewidth}%
      \lstinputlisting[#1]{#4}%
    \end{minipage}%
    \hfill%
    \begin{minipage}{#3\linewidth}%
      \vspace*{-0.6\baselineskip}%
      \centering
      \includegraphics[#6]{#5}%
    \end{minipage}
    \rule{\linewidth}{0.4pt}%
  \end{minipage}
  \vspace{\parskip}%
}
\newcommand{\inputsamplevbild}[4][]{%
     \vspace{1ex plus1.5ex}\pagebreak[2]
%     \begin{minipage}{\linewidth}
     \rule{\linewidth}{0.4pt}\nopagebreak
     \lstinputlisting[#1]{#2}
     \vspace{0.3ex plus1ex}\pagebreak[2]%
     \begin{minipage}{\linewidth}%
       \centering
       \includegraphics[#4]{#3}
       \vspace{0.3ex plus0.5ex}%
     \end{minipage}
     \rule{\linewidth}{0.4pt}%
 %    \end{minipage}%
     \vspace{0.3ex plus1ex}%
}
%
\endinput

